// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                    String    @id @default(cuid())
  email                 String    @unique
  name                  String
  password              String
  role                  UserRole  @default(user)
  address               String
  credits               Int       @default(0)
  documentationFrontUrl String?
  documentationBackUrl  String?
  number                String
  avatar                String?
  
  // Charter-specific fields (origin location for charter users)
  originAddress         String?   // Human-readable address (e.g., "St Martin 425, Buenos Aires")
  originLatitude        String?   // Charter's fixed starting location
  originLongitude       String?   // Charter's fixed starting location

  // Charter verification (default verified so existing users are not affected)
  verificationStatus    VerificationStatus @default(verified)
  rejectionReason       String?
  verifiedAt            DateTime?
  verifiedBy            String?   // Admin user ID who verified

  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  deletedAt             DateTime?

  // Relations
  trips                 Trip[]
  payments              Payment[]
  charterTrips          Trip[]    @relation("CharterTrips")
  charterAvailability   CharterAvailability?
  travelMatchesAsUser   TravelMatch[] @relation("UserMatches")
  travelMatchesAsCharter TravelMatch[] @relation("CharterMatches")
  feedbacksGiven        Feedback[] @relation("FeedbackFrom")
  feedbacksReceived     Feedback[] @relation("FeedbackTo")
  conversationsAsUser   Conversation[] @relation("UserConversations")
  conversationsAsCharter Conversation[] @relation("CharterConversations")
  messagesSent          Message[] @relation("SentMessages")
  reportsMade           Report[] @relation("ReportsMade")
  reportsReceived       Report[] @relation("ReportsReceived")

  @@map("users")
}

model Trip {
  id              String     @id @default(cuid())
  userId          String
  charterId       String
  address         String     // Direcci贸n completa del destino (ej: "Av. Hip贸lito Yrigoyen 8985, Temperley, Buenos Aires")
  latitude        String
  longitude       String
  status          TripStatus @default(pending)

  // Workers and scheduling
  workersCount    Int        @default(0)  // Number of workers to help load/unload
  scheduledDate   DateTime?               // When the trip is scheduled to start

  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt
  deletedAt       DateTime?

  // Relations
  user            User          @relation(fields: [userId], references: [id])
  charter         User          @relation("CharterTrips", fields: [charterId], references: [id])
  travelMatch     TravelMatch?
  feedbacks       Feedback[]

  @@map("trips")
}

model Payment {
  id         String        @id @default(cuid())
  userId     String
  credits    Int
  amount     Float
  status     PaymentStatus @default(pending)
  receiptUrl String?
  rejectionReason String?
  createdAt  DateTime      @default(now())
  updatedAt  DateTime      @updatedAt
  deletedAt  DateTime?

  // Relations
  user User @relation(fields: [userId], references: [id])

  @@map("payments")
}

model SystemConfig {
  id                String   @id @default(cuid())
  key               String   @unique
  value             String
  description       String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@map("system_configs")
}

model AuditLog {
  id          String   @id @default(cuid())
  entityType  String
  entityId    String
  action      String
  oldValues   Json?
  newValues   Json?
  ipAddress   String?
  location    String?
  userId      String?
  createdAt   DateTime @default(now())

  @@map("audit_logs")
}

model CharterAvailability {
  id              String   @id @default(cuid())
  charterId       String   @unique
  isAvailable     Boolean  @default(false)
  lastToggledAt   DateTime @default(now())
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  charter         User     @relation(fields: [charterId], references: [id])

  @@map("charter_availability")
}

model TravelMatch {
  id                    String              @id @default(cuid())
  userId                String
  charterId             String?             // Null until user selects a charter
  
  // Origin (user's starting point)
  pickupAddress         String              // Direcci贸n de recogida completa
  pickupLatitude        String
  pickupLongitude       String
  
  // Destination
  destinationAddress    String              // Direcci贸n de destino completa
  destinationLatitude   String
  destinationLongitude  String
  
  // Calculated values
  distanceKm            Float?              // Total distance in kilometers
  estimatedCredits      Int?                // Estimated cost in credits
  
  // Match details
  maxRadiusKm           Float               @default(30) // Maximum search radius for charters
  status                TravelMatchStatus   @default(searching)
  
  // Workers and scheduling
  workersCount          Int                 @default(0)  // Number of workers requested
  scheduledDate         DateTime?                        // When trip should start
  
  // Trip creation
  tripId                String?             @unique     // Created trip after match confirmed

  // Conversation creation
  conversationId        String?             @unique     // Created conversation when charter accepts

  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt
  expiresAt             DateTime?           // Match expiration time
  deletedAt             DateTime?

  // Relations
  user                  User                @relation("UserMatches", fields: [userId], references: [id])
  charter               User?               @relation("CharterMatches", fields: [charterId], references: [id])
  trip                  Trip?               @relation(fields: [tripId], references: [id])
  conversation          Conversation?       @relation(fields: [conversationId], references: [id])

  @@map("travel_matches")
  @@index([status])
  @@index([userId])
  @@index([charterId])
  @@index([scheduledDate])
}

model Feedback {
  id          String   @id @default(cuid())
  tripId      String
  fromUserId  String   // Who is giving the feedback
  toUserId    String   // Who is receiving the feedback
  rating      Int      // 1-5 stars
  comment     String?  // Optional comment
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  trip        Trip     @relation(fields: [tripId], references: [id])
  fromUser    User     @relation("FeedbackFrom", fields: [fromUserId], references: [id])
  toUser      User     @relation("FeedbackTo", fields: [toUserId], references: [id])

  @@unique([tripId, fromUserId]) // One feedback per user per trip
  @@map("feedbacks")
  @@index([toUserId])
  @@index([tripId])
}

model Conversation {
  id              String              @id @default(cuid())
  matchId         String              @unique
  userId          String
  charterId       String
  status          ConversationStatus  @default(active)
  closedBy        String?             // User ID who closed the conversation
  closedAt        DateTime?
  expiresAt       DateTime            // Auto-delete after 5 hours
  isArchived      Boolean             @default(false) // true if saved due to report
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  // Relations
  user            User                @relation("UserConversations", fields: [userId], references: [id])
  charter         User                @relation("CharterConversations", fields: [charterId], references: [id])
  messages        Message[]
  reports         Report[]
  travelMatch     TravelMatch?

  @@map("conversations")
  @@index([status])
  @@index([userId])
  @@index([charterId])
  @@index([expiresAt])
}

model Message {
  id              String       @id @default(cuid())
  conversationId  String
  senderId        String
  content         String       @db.Text
  isRead          Boolean      @default(false)
  createdAt       DateTime     @default(now())

  // Relations
  conversation    Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender          User         @relation("SentMessages", fields: [senderId], references: [id])

  @@map("messages")
  @@index([conversationId])
  @@index([senderId])
  @@index([createdAt])
}

model Report {
  id              String       @id @default(cuid())
  conversationId  String
  reporterId      String       // Who is making the report
  reportedId      String       // Who is being reported
  reason          String
  description     String?      @db.Text
  status          ReportStatus @default(pending)
  adminNotes      String?      @db.Text
  resolvedAt      DateTime?
  resolvedBy      String?      // Admin user ID
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  // Relations
  conversation    Conversation @relation(fields: [conversationId], references: [id])
  reporter        User         @relation("ReportsMade", fields: [reporterId], references: [id])
  reported        User         @relation("ReportsReceived", fields: [reportedId], references: [id])

  @@map("reports")
  @@index([reporterId])
  @@index([reportedId])
  @@index([status])
  @@index([conversationId])
}

enum UserRole {
  admin
  subadmin
  user
  charter
}

enum PaymentStatus {
  pending
  rejected
  accepted
}

enum TravelMatchStatus {
  searching       // User is looking for charters
  pending         // User selected a charter, waiting for confirmation
  accepted        // Charter accepted, can communicate
  rejected        // Charter rejected
  completed       // Trip created
  cancelled       // User cancelled
  expired         // Match expired
}

enum ConversationStatus {
  active          // Conversation is open
  closed          // Closed by either party
  expired         // Auto-closed after expiration
}

enum TripStatus {
  pending           // Trip confirmed, waiting for completion
  charter_completed // Charter finished work, waiting for client confirmation
  completed         // Both parties confirmed completion
  cancelled         // Trip was cancelled
}

enum ReportStatus {
  pending         // Report submitted, awaiting review
  investigating   // Admin is reviewing
  resolved        // Resolved by admin
  dismissed       // Report was dismissed
}

enum VerificationStatus {
  pending         // New charter awaiting validation
  verified        // Admin approved, can operate
  rejected        // Admin rejected
}
